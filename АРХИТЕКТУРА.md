# 🏗️ Архитектура проекта

## 📊 Схема работы на Render

```
┌─────────────────────────────────────────────────────────────┐
│                     Render Web Service                       │
│                  (csgosalleruzb.onrender.com)               │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │              Python Bot (bot.py)                    │    │
│  │                                                      │    │
│  │  ┌──────────────┐        ┌──────────────┐         │    │
│  │  │   Webhook    │        │  Web Server  │         │    │
│  │  │   Handler    │◄───────┤  (aiohttp)   │         │    │
│  │  └──────────────┘        └──────────────┘         │    │
│  │         │                        │                  │    │
│  │         │                        │                  │    │
│  │         ▼                        ▼                  │    │
│  │  ┌──────────────┐        ┌──────────────┐         │    │
│  │  │   Telegram   │        │ Static Files │         │    │
│  │  │   Commands   │        │   (HTML/JS)  │         │    │
│  │  └──────────────┘        └──────────────┘         │    │
│  │         │                        │                  │    │
│  │         └────────┬───────────────┘                 │    │
│  │                  │                                  │    │
│  │                  ▼                                  │    │
│  │         ┌──────────────┐                           │    │
│  │         │   Database   │                           │    │
│  │         │  (in-memory) │                           │    │
│  │         └──────────────┘                           │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ HTTPS
                              │
                    ┌─────────▼──────────┐
                    │   Telegram API     │
                    │   (webhook)        │
                    └─────────┬──────────┘
                              │
                              │
                    ┌─────────▼──────────┐
                    │   Пользователи     │
                    │   (Telegram)       │
                    └────────────────────┘
```

## 🔄 Поток данных

### 1. Пользователь отправляет /start
```
Пользователь → Telegram API → Webhook → bot.py → Ответ с кнопкой
```

### 2. Пользователь открывает магазин
```
Пользователь → Нажимает кнопку → Telegram WebApp → 
→ GET https://csgosalleruzb.onrender.com → 
→ serve_webapp() → index.html → Браузер
```

### 3. Загрузка статических файлов
```
index.html → GET /static/app.js → serve_static() → app.js
index.html → GET /static/translations.js → serve_static() → translations.js
```

### 4. Покупка товара
```
Пользователь → Нажимает "Купить" → WebApp → 
→ tg.sendData() → Telegram API → Webhook → 
→ handle_webapp_data() → Создание заказа → 
→ Уведомление админу
```

## 📁 Структура файлов

```
CSGOSalleruzb/
│
├── 🤖 Основные файлы бота
│   ├── bot.py                    # Главный файл (webhook + web server)
│   ├── database.py               # База данных (in-memory)
│   ├── shop.py                   # Логика магазина
│   └── admin_panel.py            # Админ-панель
│
├── 🎨 Веб-интерфейс
│   └── static-site/
│       ├── index.html            # Главная страница магазина
│       ├── app.js                # JavaScript логика
│       └── translations.js       # Переводы (RU/UZ)
│
├── 🔧 Альтернативная версия (для разработки)
│   └── bot-service/
│       ├── bot.py                # Простой бот (polling)
│       ├── database.py
│       ├── shop.py
│       └── admin_panel.py
│
├── 📦 Конфигурация
│   ├── requirements.txt          # Python зависимости
│   ├── render.yaml               # Конфиг для Render
│   └── .gitignore                # Игнорируемые файлы
│
└── 📚 Документация
    ├── README.md                 # Основная документация
    ├── RENDER_DEPLOY.md          # Деплой на Render
    ├── БЫСТРЫЙ_СТАРТ_RENDER.md   # Краткая инструкция
    ├── ИНСТРУКЦИЯ.md             # Инструкция на русском
    ├── CHANGELOG.md              # История изменений
    └── АРХИТЕКТУРА.md            # Этот файл
```

## 🌐 Endpoints

### Web Server (aiohttp)

| Path | Method | Описание |
|------|--------|----------|
| `/` | GET | Главная страница магазина |
| `/health` | GET | Health check для Render |
| `/static/{filename}` | GET | Статические файлы (JS, CSS) |
| `/webhook/{token}` | POST | Webhook для Telegram |

## 💾 База данных

**Тип:** In-memory (хранится в RAM)

**Структура:**
- `products` - товары магазина
- `auctions` - аукционы
- `orders` - заказы пользователей

**Важно:** При перезапуске сервиса данные теряются. Для продакшена рекомендуется PostgreSQL.

## 🔐 Безопасность

- Токен бота хранится в переменных окружения
- ID администраторов проверяются перед доступом к админ-панели
- Webhook использует HTTPS
- Статические файлы отдаются только для чтения

## ⚡ Производительность

### Бесплатный план Render:
- **RAM:** 512 MB
- **CPU:** Shared
- **Время отклика:** ~100-300ms (когда активен)
- **Время пробуждения:** 30-60 секунд (после засыпания)

### Оптимизации:
- Минимальные зависимости
- In-memory база данных
- Статические файлы в репозитории
- Асинхронная обработка (asyncio)

## 🔄 Масштабирование

Для роста проекта:

1. **База данных:** Перейти на PostgreSQL (бесплатно на Render)
2. **Файлы:** Использовать CDN для изображений
3. **План:** Upgrade на Starter ($7/мес) для постоянной работы
4. **Кэш:** Добавить Redis для сессий

## 📊 Мониторинг

Доступно в Render Dashboard:
- Логи в реальном времени
- Использование RAM/CPU
- Время отклика
- Количество запросов

---

**Версия:** 2.0  
**Дата:** 16 октября 2025
